"use strict";define(["jquery","core/ajax","core/templates","local_edwiserform/form_styles","local_edwiserform/iefixes","local_edwiserform/efb_form_basic_settings","local_edwiserform/formbuilder","local_edwiserform/fastsearch","local_edwiserform/fastselect"],function(e,t,i,n){var o,s={FORMTYPE:"#id_type",COMPONENT:"local_edwiserform",EVENT:"#id_events",EVENT_LIST:".efb-event-list",FORM_STYLE:".efb-form-style",RENDER_FORM:".render-form",PANEL:".efb-panel-btn",TEMPLATE_OVERLAY:".template-overlay",TITLE:"#id_title",ACTIVE:"active",FORM_TITLE:"#efb-form-title",TEMPLATES_ROOT:".efb-forms-setup-templates"},a=1,r=2,l=document.querySelector(".build-form"),d=document.querySelector(s.RENDER_FORM),f=!1,c=null,m={container:l,countries:countries,license:license,svgSprite:M.cfg.wwwroot+"/local/edwiserform/pix/formeo-sprite.svg",localStorage:!1},u=document.createEvent("Event");u.initEvent("eventsLoaded",!0,!0),window.eventlist=[];var g={GET_TEMPLATE:function(e){return t.call([{methodname:"edwiserform_get_template",args:{name:e}}])[0]},GET_EVENT_SETTINGS:function(e,i){return t.call([{methodname:"edwiserform_get_event_settings",args:{event:e,id:i}}])[0]},CREATE_NEW_FORM:function(e,i){return t.call([{methodname:"edwiserform_create_new_form",args:{setting:e,formdef:i.toString()}}])[0]},UPDATE_FORM:function(e,i){return t.call([{methodname:"edwiserform_update_form_settings",args:{setting:e,formdef:i.toString()}}])[0]}},v={SETTINGS_CONTAINER:function(e,t){var n={event:e,name:t};return i.render("local_edwiserform/event_settings_container",n)}};m.resetForm=function(){o.dom.loading();var t=e(s.FORMTYPE).val();g.GET_TEMPLATE(t).done(function(t){if(o.dom.loadingClose(),1==t.status)return m.container=l,o=new Formeo(m,t.definition),void e(s.EVENT).val().forEach(function(e){window.eventlist[e].hasOwnProperty("hasRequiredFields")&&window.eventlist[e].hasRequiredFields()&&C(e)})}).fail(function(e){o.dom.loadingClose(),o.dom.alert("danger",e.message)})},m.resetable="blank"!=e(s.FORMTYPE).val();var p={removeSelectedOption:function(t,i){if(t.value!=e(s.FORMTYPE).val()){var n=this.optionsCollection.removeSelected(t);n&&n.$item&&n.$item.removeClass(this.options.itemSelectedClass),i?i.remove():this.$el.find(selectorFromClass(this.options.choiceItemClass)+'[data-value="'+t.value+'"]').remove(),this.updateDomElements(),this.writeToInput(),e("#efb-event-"+t.value).remove()}else o.dom.toaster(M.util.get_string("efb-cannot-remove-event",s.COMPONENT,e(s.FORMTYPE).find("option:selected").html()),3e3)},setSelectedOption:function(t){if(!this.optionsCollection.isSelected(t.value))if(void 0!==window.eventlist[t.value]){window.eventlist[t.value].hasOwnProperty("hasRequiredFields")&&window.eventlist[t.value].hasRequiredFields()&&C(t.value),this.optionsCollection.setSelected(t);var n=this.optionsCollection.findWhere(function(e){return e.value===t.value});this.isMultiple?this.$controls&&this.addChoiceItem(t):(this.fastsearch&&this.fastsearch.$resultItems.removeClass(this.options.itemSelectedClass),this.$toggleBtn&&this.$toggleBtn.text(t.text)),n&&n.$item.addClass(this.options.itemSelectedClass),this.updateDomElements(),pluginhassetting.forEach(function(n){t.value==n&&w(n).done(function(o){v.SETTINGS_CONTAINER(n,t.text).done(function(t,a){i.appendNodeContents(e(s.EVENT_LIST),t,a),e("#efb-event-"+n+" .efb-event-settings").html(o.settings),1==o.status&&window.eventlist[n].hasOwnProperty("init")&&window.eventlist[n].init()})})})}else o.dom.alert("danger",M.util.get_string("efb-technical-issue-reload",s.COMPONENT),function(){window.location.reload()})}};function E(){var e=JSON.parse(T());return 0==Object.keys(e.fields).length}function _(){var t=E();e("#efb-form-preview").toggleClass("d-none",t),e(".efb-form-step-preview").toggleClass("d-none",t)}function T(){return o.formData}function h(){var t=b()&&N(!1)&&!E();return e("#efb-btn-save-form-settings").parents(".efb-editor-button").toggleClass("d-none",!t),e(".efb-form-save").toggleClass("d-none",!t),t}function w(t){var i=e("[name='id']").val(),n=g.GET_EVENT_SETTINGS(t,""!=i?i:null);return n.fail(function(e){o.dom.loadingClose(),console.log(e)}),n}function b(){return e(s.TEMPLATES_ROOT).find(".template.active").length>0}function O(t){e(s.PANEL).removeClass(s.ACTIVE),e("#efb-"+t).addClass(s.ACTIVE),e(".efb-tabcontent").removeClass(s.ACTIVE),e("#efb-cont-"+t).addClass(s.ACTIVE)}function N(t){null==t&&(t=!0);var i=R(),n=e(s.PANEL+"."+s.ACTIVE).attr("id"),a=""!=i.title;if(!t)return a;if(a)e(".efb-form-title-container").removeClass("has-danger"),e(s.TITLE).parents(".fitem").removeClass("has-danger");else{switch(n){case"efb-form-setup":case"efb-form-builder":case"efb-form-preview":case"efb-form-settings":O("form-settings"),e(s.TITLE).parents(".fitem").addClass("has-danger")}o.dom.toaster(M.util.get_string("efb-lbl-title-warning",s.COMPONENT),3e3)}return a}var C=function(t){g.GET_TEMPLATE(t).done(function(e){if(1==e.status){var t=JSON.parse(e.definition);Object.keys(t.fields).forEach(function(e){t.fields[e].hasOwnProperty("attrs")&&t.fields[e].attrs.hasOwnProperty("required")&&t.fields[e].attrs.required&&t.fields[e].hasOwnProperty("attrs")&&t.fields[e].attrs.hasOwnProperty("name")&&!o.dom.hasFieldWithName(t.fields[e].attrs.name)&&(delete t.fields[e].attrs.template,o.addMissingField(t.fields[e]))})}}).fail(function(i){e('[data-template="'+t+'"]').parents(s.TEMPLATE_OVERLAY).removeClass("loading"),o.dom.alert("danger",i.message)})};function P(t){if(e(t+"_enabled").is(":checked")){var i=e(t+"_year").val();return i+="/"+e(t+"_month").val(),i+="/"+e(t+"_day").val(),i+=" "+e(t+"_hour").val(),i+=":"+e(t+"_minute").val()+":00",new Date(i).getTime()/1e3}return 0}function R(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=e(s.FORMTYPE).val(),n=e(s.EVENT).val(),o={title:e(s.TITLE).val(),description:e("#id_description").val(),type:i,events:n.join(),enable_notifi_email:e("#id_enable_notification").prop("checked"),notifi_email:e("#id_notifi_email").val(),notifi_email_subject:e("#id_notifi_email_subject").val(),notifi_email_body:e("#id_notifi_email_body").val(),emailbodydraftitemid:e('[name="notifi_email_body[itemid]"]').val(),confirmation_subject:e("#id_confirmation_subject").val(),confirmation_message:e("#id_confirmation_msg").val(),msgdraftitemid:e('[name="confirmation_msg[itemid]"]').val(),data_edit:e("#id_editdata").prop("checked"),success_message:e("#id_success_message").val(),style:selectedStyle,allowsubmissionsfromdate:P("#id_allowsubmissionsfromdate"),allowsubmissionstodate:P("#id_allowsubmissionstodate"),eventsettings:""};if(1==t){var a={};n.forEach(function(e){pluginhassetting.forEach(function(t){e==t&&(a[e]=window.eventlist[e].getSettings())})}),o.eventsettings=JSON.stringify(a)}return o}function y(e,t,i,n){o.dom.loading(),("create"==e?g.CREATE_NEW_FORM(t,i):g.UPDATE_FORM(t,i)).done(n).fail(function(e){o.dom.loadingClose(),o.dom.alert("danger",e.message)})}function L(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";m.resetable="blank"!=t,e(s.FORMTYPE).val(t);var n=new CustomEvent("change",{target:e(s.FORMTYPE)[0]});e(s.FORMTYPE)[0].dispatchEvent(n);var a=[];a.push(t),e(s.EVENT).val(a),n=new CustomEvent("change",{target:e(s.EVENT)[0]}),e(s.EVENT)[0].dispatchEvent(n),c.destroy(),c.init(e(s.EVENT),e(s.EVENT).val()),F(),m.container=l,o=new Formeo(m,i),e("#efb-form-settings").trigger("click")}function S(t){o.dom.multiActions("warning",M.util.get_string("attention",s.COMPONENT),M.util.get_string("efb-template-inactive-license",s.COMPONENT,e(t).data("template-name")),[{title:M.util.get_string("activatelicense",s.COMPONENT),type:"success",action:function(){window.location.href=M.cfg.wwwroot+"/admin/settings.php?section=local_edwiserform&activetab=local_edwiserform_license_status"}},{title:M.util.get_string("cancel",s.COMPONENT),type:"warning"}])}function A(t){e(".efb-editor-action").toggleClass("efb-hide",t.length<0),t.length<0?e("#id_error_template_title").show():e("#id_error_template_title").hide(),t.length>33&&(t=t.substr(0,30)+"..."),e(".efb-form-title").text(t)}function F(){e(s.FORMTYPE).closest(".fitem").hide(),0==e(s.EVENT_LIST).length?e("#efb-settings-events").append('<div class="efb-event-list"></div>'):e(s.EVENT_LIST).empty();var t=e("#id_allowsubmissionsfromdate_enabled").parent(),n=e(t).parent();t.detach().prependTo(n),t=e("#id_allowsubmissionstodate_enabled").parent(),n=e(t).parent(),t.detach().prependTo(n),e(s.EVENT).val().forEach(function(t){pluginhassetting.forEach(function(n){t==n&&w(t).done(function(n){v.SETTINGS_CONTAINER(t,e(s.EVENT).find('option[value="'+t+'"]').html()).done(function(a,r){i.appendNodeContents(e(s.EVENT_LIST),a,r),e("#efb-event-"+t+" .efb-event-settings").html(n.settings),void 0!==window.eventlist[t]?1==n.status&&window.eventlist[t].hasOwnProperty("init")&&window.eventlist[t].init():o.dom.alert("danger",M.util.get_string("efb-technical-issue-reload",s.COMPONENT),function(){window.location.reload()})})})})}),null===c&&(c=e(s.EVENT).hide().fastselect({callbacks:p}))}function I(t){var i=e(t).data("template");e(t).parents(s.TEMPLATE_OVERLAY).addClass("loading"),g.GET_TEMPLATE(i).done(function(n){e(t).parents(s.TEMPLATE_OVERLAY).removeClass("loading"),1!=n.status?("license-inactive"!=n.msg&&o.dom.alert("warning",n.msg,function(){L(i,n.definition)}),S(t)):L(i,n.definition)}).fail(function(i){e(t).parents(s.TEMPLATE_OVERLAY).removeClass("loading"),o.dom.alert("danger",i.message)})}var V=function(t){if(o.dom.loadingClose(),1==t.status){if(window.onbeforeunload=null,f=!0,t.formname=e(s.TITLE).val(),null!=mod_edwiserform_return&&1==mod_edwiserform_return)return void window.opener.local_edwiserform_add_new_form(t);o.dom.alert("success",t.msg,function(){o.reset(),e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")}),setTimeout(function(){e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")},4e3)}else o.dom.alert("danger",t.msg)},x=function t(i){if(o.dom.loadingClose(),i.status==a){if(window.onbeforeunload=null,i.formname=e(s.TITLE).val(),null!=mod_edwiserform_return&&1==mod_edwiserform_return)return void window.opener.local_edwiserform_edit_form(i);o.dom.multiActions("success",M.util.get_string("success",s.COMPONENT),i.msg,[{title:M.util.get_string("efb-heading-listforms",s.COMPONENT),type:"primary",action:function(){e(location).attr("href",M.cfg.wwwroot+"/local/edwiserform/view.php?page=listforms")}},{title:M.util.get_string("close",s.COMPONENT),type:"default"}])}else if(i.status==r){var n=T(),l=R(!0);l.forceupdate=!0,l.id=e("[name='id']").val(),o.dom.multiActions("warning",M.util.get_string("attention",s.COMPONENT),i.msg,[{title:M.util.get_string("proceed",s.COMPONENT),type:"warning",action:function(){y("update",l,n,t)}},{title:M.util.get_string("cancel",s.COMPONENT),type:"success"}])}else o.dom.alert("danger",i.msg)};function k(){e(".efb-form-style-container .controls-toggle").click(function(){e(this).parents(".preview-form").toggleClass("show-styles"),e("#efb-cont-form-builder .formeo-controls").closest(".build-form").toggleClass("hidden-controls")}),e(s.FORM_STYLE).mouseenter(function(){e(".form-style-preview").attr("src",e(this).find("img").attr("src")).css("top",e(this).offset().top).show()}).mouseleave(s.FORM_STYLE,function(){e(".form-style-preview").attr("src","").hide()}).click(s.FORM_STYLE,function(){e(s.FORM_STYLE).removeClass("selected"),e(this).addClass("selected");for(var t=1;t<=supportedStyles;t++)e(s.RENDER_FORM).hasClass("form-style-"+t)&&n.apply(e(s.RENDER_FORM),"remove",t);selectedStyle=e(this).data("form"),n.apply(e(s.RENDER_FORM),"add",e(this).data("form"))}),e(".efb-settings-tab-list-item").click(function(){"available"==license||"efb-settings-events"!=e(this).data("target")?(e(".efb-settings-tab-list-item").removeClass("active"),e(this).addClass("active"),e(".efb-settings-tab").removeClass("active"),e("#"+e(this).data("target")).addClass("active")):o.dom.multiActions("warning",M.util.get_string("attention",s.COMPONENT),M.util.get_string("efb-template-inactive-license",s.COMPONENT,e(this).find("h4").text()),[{title:M.util.get_string("activatelicense",s.COMPONENT),type:"success",action:function(){window.location.href=M.cfg.wwwroot+"/admin/settings.php?section=local_edwiserform&activetab=local_edwiserform_license_status"}},{title:M.util.get_string("cancel",s.COMPONENT),type:"warning"}])}),e(".step-navigation #previous-step").click(function(){}),e(".step-navigation #next-step").click(function(){}),e(document).on("formeoUpdated",function(){var t=h();_(),t||e(s.EVENT).val().forEach(function(e){window.eventlist[e].hasOwnProperty("hasRequiredFields")&&window.eventlist[e].hasRequiredFields()&&C(e)}),o.dom.toggleImportButton()}),e(".efb-form-step").click(function(t){t.preventDefault();var i=e(this).data("id");e("#"+i).click()}),e(s.PANEL).click(function(t){if(!b())return o.dom.toaster(M.util.get_string("efb-select-template-warning",s.COMPONENT),3e3),O("form-setup"),void t.preventDefault();var i=e(this).attr("id");if("efb-form-setup"==i||"efb-form-settings"==i||N()){h();var a=e(this).data("panel");if(e("#efb-form-settings, #efb-form-builder, #efb-form-preview, #efb-form-setup").removeClass(s.ACTIVE),e("#efb-cont-form-settings, #efb-cont-form-builder, #efb-cont-form-preview, #efb-cont-form-setup").removeClass(s.ACTIVE),e(a).addClass(s.ACTIVE),e(this).addClass(s.ACTIVE),e(".efb-forms-panel-heading").text(e(this).data("panel-lbl")),"#efb-cont-form-preview"==a){o.render(d);for(var r=1;r<=supportedStyles;r++)e(s.RENDER_FORM).hasClass("form-style-"+r)&&n.apply(e(s.RENDER_FORM),"remove",r);n.apply(e(s.RENDER_FORM),"add",selectedStyle)}}else t.preventDefault()}),e("body").on("click",".efb-event-label",function(t){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;""!=e(this).next().html()&&function(t,i){if(e(t).parent(".efb-event").hasClass("collapsed")){i||e(".efb-event:not(.collapsed) h4").each(function(t,i){e(i).trigger("click",[!0])}),e(t).parent(".efb-event").removeClass("collapsed"),e(t).next().height("auto");var n=e(t).next()[0].clientHeight+"px";e(t).next().height("0px"),setTimeout(function(){e(t).next().height(n)},0)}else e(t).next().height("0px"),e(t).next()[0].addEventListener("transitionend",function(){e(t).parent(".efb-event").addClass("collapsed")},{once:!0})}(this,i)}).on("click",".efb-email-tag",function(){var t=e("<input>");e("body").append(t);var i=e(this).text();t.val(i).select(),document.execCommand("copy"),t.remove(),o.dom.toaster(M.util.get_string("shortcodecopied",s.COMPONENT,i),3e3)}).on("click","#efb-btn-save-form-settings",function(t){if(!b())return o.dom.toaster(M.util.get_string("efb-select-template-warning",s.COMPONENT),3e3),O("form-setup"),void t.preventDefault();if(N()&&o.validator.validate()){var i=R(!0);if(i.allowsubmissionsfromdate>=i.allowsubmissionstodate&&0!=i.allowsubmissionstodate)e("#id_allowsubmissionstodate_calendar").parent(".fdate_time_selector").next().show().text(M.util.get_string("allowsubmissionscollapseddate",s.COMPONENT)).parents(".form-group.row.fitem").addClass("has-danger");else{e("#id_allowsubmissionstodate_calendar").parent(".fdate_time_selector").next().show().text("").parents(".form-group.row.fitem").removeClass("has-danger");var n=T(),a=e("[name='id']").val(),r="create";a?o.dom.multiActions("warning",M.util.get_string("attention",s.COMPONENT),M.util.get_string("efb-forms-update-confirm",s.COMPONENT),[{title:M.util.get_string("efb-forms-update-create-new",s.COMPONENT),type:"primary",action:function(){y(r,i,n,V)}},{title:M.util.get_string("efb-forms-update-overwrite-existing",s.COMPONENT),type:"warning",action:function(){r="update",i.id=a,y(r,i,n,x)}}]):f?o.dom.toaster(M.util.get_string("efb-form-setting-saved",s.COMPONENT),3e3):y(r,i,n,V)}}}),e(s.FORM_TITLE).keyup(function(){var t=e(this).val(),i=""==t;e(this).parent().toggleClass("has-danger",i),e(s.TITLE).val(t),A(t)}).change(function(){h()}),e(s.TITLE).keyup(function(){var t=e(this).val();e(s.TITLE).val(t),A(t)}).change(function(){var t=e(this).val();e(s.FORM_TITLE).val(t),h()}),e(s.FORMTYPE).change(function(){e(s.TEMPLATES_ROOT).find(".template").removeClass("active");var t=e(this).val();e(s.TEMPLATES_ROOT).find("#template-"+t).addClass("active"),e("#id_registration-enabled").prop("checked",!0)}),e(s.TEMPLATES_ROOT).find(".template-select").click(function(){var t=this;1!=e(this).data("pro")||"available"==license?(h(),e(s.TEMPLATES_ROOT).find(".template.active").length&&!E()?o.dom.multiActions("warning",M.util.get_string("attention",s.COMPONENT),M.util.get_string("efb-template-change-warning",s.COMPONENT),[{title:M.util.get_string("proceed",s.COMPONENT),type:"warning",action:function(){I(t)}},{title:M.util.get_string("cancel",s.COMPONENT),type:"success"}]):I(t)):S(this)}),e(document).on("formeoLoaded",function(){_()}),document.addEventListener("eventsLoaded",function(){F(),h(),o.dom.loadingClose()})}return{init:function(t){e(document).ready(function(){var i,n;m.sitekey=t,o="undefined"!=typeof formdefinition?new Formeo(m,formdefinition):new Formeo(m),_(),e("#root-page-loading").hide(),o.dom.loading(),i=0,(n=e(s.EVENT).find("option").map(function(e,t){return t.value})).length>0?n.each(function(t,o){require(["edwiserformevents_"+o+"/settings"],function(t){window.eventlist[o]=t,n.length==++i&&(e(".efb-form-builder-wrap").show(),k(),document.dispatchEvent(u))})}):(k(),e(".efb-form-builder-wrap").show())})}}});
//# sourceMappingURL=new_form_main.min.js.map
