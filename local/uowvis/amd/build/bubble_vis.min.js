define ("local_uowvis/bubble_vis",["local_uowvis/d3","local_uowvis/d3-simple-slider","core/log","jquery","core/ajax","core/str","core/notification","core/templates","core/form-autocomplete"],function(a,b,c,f,d,e,g,h,i){function j(){this.vis_canvas=null;this.current_canvas=null;this.previous_canvas=null;this.x_axis=null;this.config=null;this.y_axis=null;this.x_axis_label=null;this.y_axis_label=null;this.maxdate=null;this.mindate=null;this.totalcourses=null;this.courseid_to_name_map=null;this.date_options=null;this.totalwidth=null;this.height=null;this.totalheight=null;this.drawing_div_id=null;this.data=null;this.tooltip=null;this.can_change=null;this.gData=null;this.searchcourses_label=null;this.redrawing=null}j.prototype.init=function(a,b,h,i){c.debug("Creating graph at div with id "+a+" for following courses "+b.join(","));c.debug("Calling data endpoints");var j=d.call([{methodname:"local_uowvis_get_visdata",args:{courseids:b}},{methodname:"local_uowvis_get_coursedata",args:{allcourses:h,selected:b}}]);c.debug("Fetching relevant strings");var k=e.get_strings([{key:"timelabel",component:"local_uowvis"},{key:"courselabel",component:"local_uowvis"},{key:"nocourses",component:"local_uowvis"},{key:"searchcourses",component:"local_uowvis"}]);this.can_change=i;this.course_ids=b;this.all_ids=h;this.drawing_div_id=a;this.config={top:50,right:120,bottom:100,left:135,width:900,rowheight:60,min_radius:2,max_radius:30,legend_radius:8,legend_start:40,legend_width:100,x_ticks:10,timelineheight:100};this.date_options={weekday:"long",year:"numeric",month:"long",day:"numeric"};f.when(j[0],j[1],k).done(this.bootstrap_visualisation.bind(this)).fail(g.exception)};j.prototype.redraw=function(){if(this.redrawing){c.debug("already redrawing, refusing request");return}this.redrawing=!0;c.debug("Recreating graph at div with id "+this.drawing_div_id+" for following courses "+this.course_ids.join(","));c.debug("Calling data endpoint");var b=d.call([{methodname:"local_uowvis_get_visdata",args:{courseids:this.course_ids}},{methodname:"local_uowvis_get_coursedata",args:{allcourses:this.all_ids,selected:this.course_ids}}]),e=a.select("#"+this.drawing_div_id).append("div");this.previous_canvas=this.current_canvas;this.current_canvas=e;this.current_canvas.style("visibility","hidden");this.current_canvas.style("opacity","0");f.when(b[0],b[1]).done(this.draw_visualisation.bind(this,e)).fail(g.exception)};j.prototype.bootstrap_visualisation=function(b,c,d){this.x_axis_label=d[0];this.y_axis_label=d[1];this.nocourse_label=d[2];this.searchcourses_label=d[3];var e=a.select("#"+this.drawing_div_id).append("div");this.current_canvas=e;this.draw_visualisation(e,b,c)};j.prototype.draw_visualisation=function(a,b,d){var e=new Date(1e3*b.maxdate),f=new Date(1e3*b.mindate);this.totalcourses=parseInt(b.totalcourses);this.courseid_to_name_map={};d.forEach(function(a){this.courseid_to_name_map[a.courseid]=a.shortname}.bind(this));var g=this.config;this.data=b;this.totalwidth=g.width+g.left+g.right+g.legend_width;var h=g.rowheight*this.totalcourses,i=b.moduledata.length*(2*g.legend_radius+10);this.height=h;if(this.height<i){this.height=i}this.totalheight=this.height+g.top+g.bottom;this.x_axis=this.setup_x_axis(f,e,g.width);this.y_axis=this.setup_y_axis(b.courseids,this.height);this.z_axis=this.setup_z_axis(g.min_radius,g.max_radius);this.color_scale=this.setup_color_scale(b.modulenames);this.tooltip=this.setup_tooltip();c.info("UoW Bubble Vis drawing graph from response data width:"+this.totalwidth+" height:"+this.totalheight);if(this.can_change){var j=a.append("div").classed("uowvis-selection-container",!0);this.draw_course_selection(j,d)}if(0<this.course_ids.length){var k=a.append("div").classed("svg-container",!0);this.vis_canvas=k.append("svg").attr("preserveAspectRatio","xMinYMin meet").attr("viewBox","0 0 "+this.totalwidth+" "+this.totalheight).classed("svg-content-responsive",!0).append("svg").attr("width",this.totalwidth).attr("height",this.totalheight).append("g").attr("transform","translate("+g.left+","+g.top+")");c.debug("Drawing the x_axis");this.draw_x_axis(this.vis_canvas,this.x_axis,g.width,this.height,g.x_ticks,this.x_axis_label);var l=function(a){return this.courseid_to_name_map[a]}.bind(this);c.debug("Drawing the y axis");this.draw_y_axis(this.vis_canvas,this.y_axis,b.courseids,l,this.y_axis_label,-1*g.left);c.debug("Drawing the grid lines");this.draw_gridlines(this.vis_canvas,g.width,this.height,this.x_axis,this.y_axis);c.debug("Drawing the vis data");this.gData=this.vis_canvas.append("g").attr("class","data");this.draw_assessment_data(this.gData,b.assessment_data,this.x_axis,this.y_axis,this.z_axis,this.color_scale);c.debug("Drawing legend:"+g.legend_start+" "+g.legend_radius+" "+g.width);this.draw_legend(this.vis_canvas,b.moduledata,g.legend_start,g.legend_radius,g.width,this.color_scale);c.debug("Drawing timeline range");this.draw_timeline(this.vis_canvas,this.totalheight,g,this.x_axis)}else{a.append("text").text(this.nocourse_label)}if(null!==this.previous_canvas){c.debug("Clearing old canvas as drawing complete");this.previous_canvas.remove();this.current_canvas.style("visibility","visible");this.current_canvas.transition().duration(400).style("opacity",1);this.previous_canvas.transition().duration(400).style("opacity",0).remove()}this.redrawing=!1};j.prototype.draw_timeline=function(c,d,e,f){var g=f.domain(),h=g[0],i=g[1],j=b.sliderHorizontal().min(h).max(i).width(e.width).displayFormat(a.timeFormat("%B %d")).default([h,i]).fill("#2196f3").on("end",function(a){this.redraw_data(a)}.bind(this)),k=c.append("g").attr("transform","translate(0,"+(d-e.bottom)+")");k.call(j)};j.prototype.redraw_data=function(a){var b=a[0],e=a[1],f=this.data.assessment_data.filter(function(a){var c=new Date(1e3*a.duedate);return c>b&&c<e}),g=this.setup_x_axis(b,e,this.config.width);this.draw_x_axis(this.vis_canvas,g,this.config.width,this.height,this.config.x_ticks,this.x_axis_label);this.draw_assessment_data(this.gData,f,g,this.y_axis,this.z_axis,this.color_scale);c.debug("Data and X axis redrawn in response to timeline request")};j.prototype.draw_gridlines=function(b,c,d,e,f){b.append("g").attr("class","uowvis_grid").attr("transform","translate(0, "+d+")").call(a.axisBottom(e).ticks(5).tickSize(-d).tickFormat(""));b.append("g").attr("class","uowvis_grid").call(a.axisLeft(f).ticks(5).tickSize(-c).tickFormat(""))};j.prototype.setup_x_axis=function(b,c,d){var e=a.scaleTime().domain([b,c]).range([0,d]).nice();return e};j.prototype.draw_x_axis=function(b,c,d,e,f,g){b.selectAll(".x-axis").remove();b.selectAll(".x-axis-label").remove();b.append("g").attr("class","x-axis").attr("transform","translate(0,"+e+")").call(a.axisBottom(c).ticks(f));b.append("text").attr("class","x-axis-label").attr("text-anchor","end").attr("x",d/2).attr("y",e+40).text(g)};j.prototype.setup_y_axis=function(b,c){var d=a.scalePoint().domain(b).range([0,c]).padding(1);return d};j.prototype.draw_y_axis=function(b,c,d,e,f,g){b.append("g").attr("class","y-axis").call(a.axisLeft(c).ticks(d).tickFormat(e));b.append("text").attr("text-anchor","end").attr("x",g).attr("y",3).text(f).attr("text-anchor","start")};j.prototype.setup_z_axis=function(b,c){var d=a.scaleLinear().domain([0,100]).range([b,c]);return d};j.prototype.setup_color_scale=function(b){var c=a.scaleOrdinal().domain(b).range(a.schemeTableau10);return c};j.prototype.setup_tooltip=function(){var b=a.select("body").append("div").attr("class","tooltip").style("background-color","black").style("border-radius","5px").style("padding","10px").style("color","white");return b};j.prototype.showTooltip=function(b){var c=this.tooltip,d=this.config,g={course:b.course,name:b.name,date:new Date(1e3*b.duedate).toLocaleDateString(void 0,this.date_options),grade_percent:b.weight},h=e.get_string("tooltip","local_uowvis",g);f.when(h).done(function(a){c.html(a)}.bind(this));c.transition().duration(100);c.style("opacity",1).style("left",a.event.pageX+d.max_radius+"px").style("top",a.event.pageY+d.max_radius+"px")};j.prototype.moveTooltip=function(){var b=this.tooltip,c=this.config;b.style("left",a.event.pageX+c.max_radius+"px").style("top",a.event.pageY+c.max_radius+"px")};j.prototype.hideTooltip=function(){this.tooltip.style("opacity",0).style("left","0px").style("top","0px")};j.prototype.highlight=function(b){a.selectAll("#"+this.drawing_div_id+" .bubbles").style("opacity",.05);a.selectAll("#"+this.drawing_div_id+" ."+b.type).style("opacity",.8);c.debug("Highlighting: "+b.type)};j.prototype.noHighlight=function(){a.selectAll(".bubbles").style("opacity",.8)};j.prototype.draw_assessment_data=function(a,b,c,e,f,g){a.selectAll("circle").data(b).join("circle").attr("cx",function(a){return c(new Date(1e3*a.duedate))}).attr("cy",function(a){return e(a.courseid)}).attr("r",function(a){return f(a.weight)}).style("fill",function(a){return g(a.modulename)}).attr("class",function(a){return"bubbles "+a.modulename}).style("opacity","0.8").attr("stroke","black").on("mouseover",this.showTooltip.bind(this)).on("mousemove",this.moveTooltip.bind(this)).on("mouseleave",this.hideTooltip.bind(this))};j.prototype.draw_legend=function(a,b,c,e,f,g){a.selectAll("myrect").data(b).enter().append("circle").attr("cx",f+c).attr("cy",function(a,b){return b*(2*e+10)}).attr("r",e).attr("id",function(a){return a.type}).style("fill",function(a){return g(a.type)}).on("mouseover",this.highlight.bind(this)).on("mouseleave",this.noHighlight.bind(this));a.selectAll("mylabels").data(b).enter().append("text").attr("x",f+c+2*e).attr("y",function(a,b){return b*(2*e+10)+e/2}).style("fill",function(a){return g(a.type)}).text(function(a){return a.langstring}).attr("id",function(a){return a.type}).attr("text-anchor","left").style("alignment-baseline","middle").on("mouseover",this.highlight.bind(this)).on("mouseleave",this.noHighlight.bind(this))};j.prototype.draw_course_selection=function(a,b){var c={};c.selected_courses=[];c.divid=this.drawing_div_id;c.all_courses=b;h.render("local_uowvis/selection_panel",c).then(function(b,c){a.html(c);f("#uowvis-course-select-"+b.drawing_div_id).change(b.selected_course.bind(b));i.enhance("#uowvis-course-select-"+b.drawing_div_id,!1,"local_uowvis/bubble_vis_datasource",b.searchcourses_label,!1,!0,"")}.bind(null,this)).fail(g.exception)};j.prototype.remove_courseid=function(a){a.preventDefault();if(this.redrawing){c.debug("Redrawing, refusing to update courses");return}var b=f(a.currentTarget).data("courseid");c.debug("Deletion click event on graph at"+this.drawing_div_id);this.course_ids=this.course_ids.filter(function(a,b){return a!=b}.bind(null,b));this.redraw()};j.prototype.selected_course=function(a){a.preventDefault();if(this.redrawing){c.debug("Redrawing, refusing to update courses");return}var b=f(a.currentTarget).val();this.course_ids=b;this.all_ids=b;this.redraw()};return{init:{init:function init(a,b,c,d){var e=new j;e.init(a,b,c,d)}}.init}});
//# sourceMappingURL=bubble_vis.min.js.map
