define ("mod_livepoll/livepoll-lazy",["jquery","core/log","core/templates"],function(a,b,c){var d=this,e=function(){d.votes=[];a.each(d.options,function(a){d.votes[a]=0})},f=function(){if(d.listeningToClicks){return}a(".livepoll-votebtn").on("click",function(){var b=a(this).data("option"),c={option:b},e=d.database.ref("polls/"+d.pollKey+"/votes/"+d.userKey);e.once("value").then(function(a){if(a.val()&&a.val().option===c.option){e.remove()}else{e.set(c)}})});d.listeningToClicks=!0},g=function(){a("#livepoll_closevoting").on("change",function(){var a=this.checked,b=d.database.ref("polls/"+d.pollKey+"/controls/closeVoting");b.set(a)});a("#livepoll_highlightanswer").on("change",function(){var a=this.checked,b=d.database.ref("polls/"+d.pollKey+"/controls/higlightAnswer");b.set(a)});if(!d.closeVoting){a(".livepoll-votebtn").removeClass("disabled");f()}},h=function(){if(!d.listeningToClicks){return}a(".livepoll-votebtn").off("click");d.listeningToClicks=!1},i=function(){var c=[];a.each(d.resultHandlers,function(a,b){var e=b.update(d.options,d.votes);c.push(e)});a.when.apply(a,c).done(function(){b.debug("livepoll UI has been updated.")})},j=function(){var b=d.database.ref("polls/"+d.pollKey+"/votes");b.once("value").then(function(b){var c=b.val();e();a(".livepoll-votebtn").addClass("btn-primary").removeClass("btn-success");a.each(c,function(b,c){d.votes[c.option]++;if(b===d.userKey){a(".livepoll-votebtn[data-option=\""+c.option+"\"]").addClass("btn-success").removeClass("btn-primary")}});i()})},k=function(){var b=d.database.ref("polls/"+d.pollKey+"/controls");b.once("value").then(function(b){var e=b.val();d.closeVoting=!!e.closeVoting;d.higlightAnswer=!!e.higlightAnswer;a("#livepoll_closevoting").prop("checked",d.closeVoting);a("#livepoll_highlightanswer").prop("checked",d.higlightAnswer);a(".livepoll-votebtn").toggleClass("disabled",d.closeVoting);if(d.closeVoting){h();if(0===a(".livepoll-closed-voting-msg > .alert").length){c.render("mod_livepoll/voting_closed",{}).then(function(b,d){c.appendNodeContents(".livepoll-closed-voting-msg",b,d);a(".livepoll-closed-voting-msg > .alert").alert().removeClass("hide").addClass("show")})}}else{f();if(0<a(".livepoll-closed-voting-msg > .alert").length){a(".livepoll-closed-voting-msg > .alert").alert("close")}}a(".livepoll-votebtn").removeClass("livepoll-answer-animation");a(".mod-livepoll-text-result").removeClass("livepoll-answer-animation");if(d.higlightAnswer){a(".livepoll-votebtn[data-option=\""+d.correctOption+"\"]").addClass("livepoll-answer-animation");a(".mod-livepoll-text-result:has(#vote-count-"+d.correctOption+")").addClass("livepoll-answer-animation")}})},l=function(){var a=d.database.ref("polls/"+d.pollKey+"/votes");a.on("child_added",j);a.on("child_changed",j);a.on("child_removed",j);var b=d.database.ref("polls/"+d.pollKey+"/controls");b.on("child_added",k);b.on("child_changed",k);b.on("child_removed",k);i()},m=function(){var b=a.Deferred(),c=[];d.resultHandlers=[];var e=["green","bold","shadowy"];a.each(d.resultsToRender,function(b,f){var g=a.Deferred();require(["mod_livepoll/"+f+"-result-lazy"],function(b){if("text"===f){var c=new b,h=[];a.each(e,function(b,d){var e=a.Deferred();h.push(e.promise());require(["mod_livepoll/"+d+"-text-result-lazy"],function(a){c=new a(c);e.resolve()})});a.when.apply(a,h).done(function(){d.resultHandlers.push(c);g.resolve()})}else{d.resultHandlers.push(new b);g.resolve()}});c.push(g.promise())});a.when.apply(a,c).done(function(){b.resolve()});return b.promise()},n=function(){var a={apiKey:d.apiKey,authDomain:d.authDomain,databaseURL:d.databaseURL,projectId:d.projectID};d.firebase.initializeApp(a);d.database=d.firebase.database();d.auth=d.firebase.auth();d.auth.signInAnonymously().catch(function(a){var c=a.code,d=a.message;b.error("Could not authenticate into firebase using anonymous setup.");b.error(c);b.error(d)});d.auth.onAuthStateChanged(function(a){if(a){b.debug("User has signed in to firebase.");d.fbuser=a;m().done(function(){l();g()})}else{b.debug("User has signed out from firebase.")}})};return{init:function init(c,f,g,h,i,j,k,l,m){d.apiKey=c;d.authDomain=f;d.databaseURL=g;d.projectID=h;d.options=k;d.correctOption=l;d.pollKey=i;d.userKey=j;d.resultsToRender=m;d.closeVoting=!1;d.higlightAnswer=!1;d.listeningToClicks=!1;e();a(document).ready(function(){if(void 0===firebase){b.error("Firebase not found. Live poll will not work.");return}d.firebase=firebase;n()})}}});
//# sourceMappingURL=livepoll-lazy.min.js.map
