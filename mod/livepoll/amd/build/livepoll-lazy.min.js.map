{"version":3,"sources":["../src/livepoll-lazy.js"],"names":["define","$","Log","templates","self","resetVotes","votes","each","options","optionid","addClickListeners","listeningToClicks","on","option","data","vote","voteRef","database","ref","pollKey","userKey","once","then","voteSnapshot","val","remove","set","addControlListeners","closeVoting","checked","controlRef","higlightAnswer","removeClass","removeClickListeners","off","updateVoteUI","promises","resultHandlers","i","handler","promise","update","push","when","apply","done","debug","updateVoteCount","votesRef","votesSnapshot","addClass","updateControls","controlsRef","controlsSnapshot","controlStatus","prop","toggleClass","length","render","html","js","appendNodeContents","alert","correctOption","addDBListeners","initVoteUI","dfd","Deferred","subPromises","textDecorators","resultsToRender","rType","reqDfd","require","Handler","currentTxtResult","txtPromises","decoratorId","txtDfd","TextDecorator","resolve","initFirebase","config","apiKey","authDomain","databaseURL","projectId","projectID","firebase","initializeApp","auth","signInAnonymously","catch","error","errorCode","code","errorMessage","message","onAuthStateChanged","user","fbuser","init","document","ready"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Live poll main module.\n *\n * @package mod_livepoll\n * @copyright Copyright (c) 2018 Open LMS\n * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine([\"jquery\", \"core/log\", \"core/templates\"],\n    function($, Log, templates) {\n\n        var self = this;\n\n        /**\n         * Resets the vote count for each option to 0.\n         */\n        var resetVotes = function() {\n            self.votes = [];\n            $.each(self.options, function(optionid) {\n                self.votes[optionid] = 0;\n            });\n        };\n\n        /**\n         * Adds the click listener to each vote btn so the vote firebase db is updated.\n         */\n        var addClickListeners = function() {\n            if (self.listeningToClicks) {\n                return;\n            }\n            $(\".livepoll-votebtn\").on(\"click\", function(){\n                var option = $(this).data(\"option\");\n                var vote = {\n                    option: option\n                };\n                var voteRef = self.database.ref(\"polls/\" + self.pollKey + \"/votes/\" + self.userKey);\n                voteRef.once(\"value\").then(function(voteSnapshot) {\n                    if (voteSnapshot.val() && voteSnapshot.val().option === vote.option) {\n                        voteRef.remove();\n                    } else {\n                        voteRef.set(vote);\n                    }\n                });\n            });\n\n            self.listeningToClicks = true;\n        };\n\n        var addControlListeners = function() {\n            $(\"#livepoll_closevoting\").on(\"change\", function() {\n                var closeVoting = this.checked;\n                var controlRef = self.database.ref(\"polls/\" + self.pollKey + \"/controls/closeVoting\");\n                controlRef.set(closeVoting);\n            });\n\n            $(\"#livepoll_highlightanswer\").on(\"change\", function() {\n                var higlightAnswer = this.checked;\n                var controlRef = self.database.ref(\"polls/\" + self.pollKey + \"/controls/higlightAnswer\");\n                controlRef.set(higlightAnswer);\n            });\n\n            // Enable voting as default behaviour.\n            if (!self.closeVoting) {\n                $(\".livepoll-votebtn\").removeClass(\"disabled\");\n                addClickListeners();\n            }\n        };\n\n        var removeClickListeners = function() {\n            if (!self.listeningToClicks) {\n                return;\n            }\n\n            $(\".livepoll-votebtn\").off(\"click\");\n            self.listeningToClicks = false;\n        };\n\n        /**\n         * Updates the vote UI.\n         * Chart and text vote count.\n         */\n        var updateVoteUI = function() {\n            var promises = [];\n            $.each(self.resultHandlers, function(i, handler) {\n                var promise = handler.update(self.options, self.votes);\n                promises.push(promise);\n            });\n            $.when.apply($, promises).done(function() {\n                Log.debug(\"livepoll UI has been updated.\");\n            });\n        };\n\n        /**\n         * Updates the voute count and vote UI for a poll snapshot.\n         */\n        var updateVoteCount = function() {\n            var votesRef = self.database.ref(\"polls/\" + self.pollKey + \"/votes\");\n            votesRef.once(\"value\").then(function(votesSnapshot) {\n                var votes = votesSnapshot.val();\n                resetVotes();\n                $(\".livepoll-votebtn\").addClass(\"btn-primary\").removeClass(\"btn-success\");\n                $.each(votes, function( userKey, vote ) {\n                    self.votes[vote.option]++;\n                    if (userKey === self.userKey) {\n                        $(\".livepoll-votebtn[data-option=\\\"\" + vote.option + \"\\\"]\")\n                            .addClass(\"btn-success\").removeClass(\"btn-primary\");\n                    }\n                });\n                updateVoteUI();\n            });\n        };\n\n        /**\n         * Upadtes control input state.\n         */\n        var updateControls = function() {\n            var controlsRef = self.database.ref(\"polls/\" + self.pollKey + \"/controls\");\n\n            controlsRef.once(\"value\").then(function(controlsSnapshot) {\n                var controlStatus = controlsSnapshot.val();\n\n                self.closeVoting = !!controlStatus.closeVoting;\n                self.higlightAnswer = !!controlStatus.higlightAnswer;\n\n                $(\"#livepoll_closevoting\").prop('checked', self.closeVoting);\n                $(\"#livepoll_highlightanswer\").prop('checked', self.higlightAnswer);\n\n                $(\".livepoll-votebtn\").toggleClass(\"disabled\", self.closeVoting);\n\n\n                if (self.closeVoting) {\n                    removeClickListeners();\n                    var tmpltName = \"mod_livepoll/voting_closed\";\n                    if ($(\".livepoll-closed-voting-msg > .alert\").length === 0) {\n                        templates.render(tmpltName, {}).then(function(html, js) {\n                            templates.appendNodeContents(\".livepoll-closed-voting-msg\", html, js);\n                            $(\".livepoll-closed-voting-msg > .alert\")\n                                .alert().removeClass(\"hide\").addClass(\"show\");\n                        });\n                    }\n                } else {\n                    addClickListeners();\n                    if ($(\".livepoll-closed-voting-msg > .alert\").length > 0) {\n                        $(\".livepoll-closed-voting-msg > .alert\")\n                            .alert(\"close\");\n                    }\n                }\n\n                $(\".livepoll-votebtn\").removeClass(\"livepoll-answer-animation\");\n                $(\".mod-livepoll-text-result\").removeClass(\"livepoll-answer-animation\");\n                if (self.higlightAnswer) {\n                    $(\".livepoll-votebtn[data-option=\\\"\" + self.correctOption + \"\\\"]\")\n                        .addClass(\"livepoll-answer-animation\");\n                    $(\".mod-livepoll-text-result:has(#vote-count-\" + self.correctOption + \")\")\n                        .addClass(\"livepoll-answer-animation\");\n                }\n            });\n        };\n\n        /**\n         * Adds listeners for state changes in the poll.\n         */\n        var addDBListeners = function() {\n            var votesRef = self.database.ref(\"polls/\" + self.pollKey + \"/votes\");\n            votesRef.on(\"child_added\", updateVoteCount);\n            votesRef.on(\"child_changed\", updateVoteCount);\n            votesRef.on(\"child_removed\", updateVoteCount);\n\n            var controlsRef = self.database.ref(\"polls/\" + self.pollKey + \"/controls\");\n            controlsRef.on(\"child_added\", updateControls);\n            controlsRef.on(\"child_changed\", updateControls);\n            controlsRef.on(\"child_removed\", updateControls);\n\n            updateVoteUI();\n        };\n\n        /**\n         *\n         * @returns {*|jQuery}\n         */\n        var initVoteUI = function() {\n            var dfd = $.Deferred(), subPromises = [];\n            self.resultHandlers = [];\n            var textDecorators = [\"green\", \"bold\", \"shadowy\"];\n            $.each(self.resultsToRender, function(i, rType) {\n                var reqDfd = $.Deferred();\n                require(\n                    [\n                        \"mod_livepoll/\" + rType + \"-result-lazy\"\n                    ], function(Handler) {\n                        if (rType === \"text\") {\n                            var currentTxtResult = new Handler(), txtPromises = [];\n\n                            $.each(textDecorators, function(i, decoratorId) {\n                                var txtDfd = $.Deferred();\n                                txtPromises.push(txtDfd.promise());\n                                require(\n                                    [\n                                        \"mod_livepoll/\" + decoratorId + \"-text-result-lazy\"\n                                    ], function(TextDecorator) {\n                                        currentTxtResult = new TextDecorator(currentTxtResult);\n                                        txtDfd.resolve();\n                                    }\n                                );\n                            });\n\n                            $.when.apply($, txtPromises).done(function() {\n                                self.resultHandlers.push(currentTxtResult);\n                                reqDfd.resolve();\n                            });\n                        } else {\n                            self.resultHandlers.push(new Handler());\n                            reqDfd.resolve();\n                        }\n                    }\n                );\n                subPromises.push(reqDfd.promise());\n            });\n\n            $.when.apply($, subPromises).done(function() {\n                dfd.resolve();\n            });\n\n            return dfd.promise();\n        };\n\n        /**\n         * Initializes firebase library.\n         */\n        var initFirebase = function() {\n            // Set the configuration for your app.\n            var config = {\n                apiKey: self.apiKey,\n                authDomain: self.authDomain,\n                databaseURL: self.databaseURL,\n                projectId: self.projectID,\n            };\n\n            self.firebase.initializeApp(config);\n\n            // Get a reference to the database service.\n            self.database = self.firebase.database();\n            self.auth = self.firebase.auth();\n            self.auth.signInAnonymously().catch(function(error) {\n                // Handle Errors here.\n                var errorCode = error.code;\n                var errorMessage = error.message;\n                Log.error(\"Could not authenticate into firebase using anonymous setup.\");\n                Log.error(errorCode);\n                Log.error(errorMessage);\n            });\n            self.auth.onAuthStateChanged(function(user) {\n                if (user) {\n                    Log.debug(\"User has signed in to firebase.\");\n                    self.fbuser = user;\n                    initVoteUI().done(function() {\n                        addDBListeners();\n                        addControlListeners();\n                    });\n                } else {\n                    Log.debug(\"User has signed out from firebase.\");\n                }\n            });\n        };\n\n        /**\n         * Module initialization function.\n         *\n         * @param apiKey\n         * @param authDomain\n         * @param databaseURL\n         * @param projectID\n         * @param pollKey\n         * @param userKey\n         * @param options\n         * @param correctOption\n         * @param resultsToRender\n         */\n        var init = function(apiKey, authDomain, databaseURL, projectID, pollKey, userKey, options, correctOption, resultsToRender) {\n            self.apiKey = apiKey;\n            self.authDomain = authDomain;\n            self.databaseURL = databaseURL;\n            self.projectID = projectID;\n            self.options = options;\n            self.correctOption = correctOption;\n            self.pollKey = pollKey;\n            self.userKey = userKey;\n            self.resultsToRender = resultsToRender;\n            self.closeVoting = false;\n            self.higlightAnswer = false;\n            self.listeningToClicks = false;\n\n            resetVotes();\n\n            $(document).ready(function() {\n                /* global firebase */\n                if (undefined === firebase) {\n                    Log.error(\"Firebase not found. Live poll will not work.\");\n                    return;\n                }\n                self.firebase = firebase;\n                initFirebase();\n            });\n        };\n\n        return {\n            \"init\": init\n        };\n    });\n"],"file":"livepoll-lazy.min.js"}