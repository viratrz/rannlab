define(["jquery","core/ajax","core/str"],function(t,e,a){return{analytic:function(){var n,i,s,l,o,d,r,c,p,u,f,g,h=[];Chart.plugins.register({beforeDraw:function(t){var e=t.chart.ctx;e.fillStyle="white",e.fillRect(0,0,t.chart.width,t.chart.height)}}),t(".viewanalytic").click(function(){var y=t(this).data("quiz_id");e.call([{methodname:"moodle_quizanalytics_analytic",args:{quizid:y}}])[0].done(function(e){var m=jQuery.parseJSON(e);m&&(u=0==m.allQuestions.length?console.log(m):m.allQuestions,m.quizid&&(y=m.quizid),m.url&&(f=m.url),m.lastUserQuizAttemptID&&(g=m.lastUserQuizAttemptID),t("#page-grade-report-quizanalytics-index").find(".btn-navbar").on("click",function(){t(this).toggleClass("active-drop"),t(this).hasClass("active-drop")?t("#page-grade-report-quizanalytics-index").find(".nav-collapse").show():t("#page-grade-report-quizanalytics-index").find(".nav-collapse").hide()}),t("#page-grade-report-quizanalytics-index .alyticsul li").each(function(e){t(this).on("click",function(){t("#page-grade-report-quizanalytics-index .alyticsul li a").removeClass("active"),t(this).find("a").addClass("active")})}),t("#page-grade-report-quizanalytics-index").find(".nav").find(".dropdown").on("click",function(e){t(this).toggleClass("open")}),t("#page-grade-report-quizanalytics-index").find(".nav").find(".dropdown").find(".dropdown-menu").find(".dropdown-submenu ").on("click",function(e){e.preventDefault(),e.stopPropagation(),t(this).toggleClass("open")}),t("#page-grade-report-quizanalytics-index").find(".nav").find(".dropdown").find(".dropdown-menu").find(".dropdown-submenu ").find("ul").find("li").find("a").on("click",function(e){e.preventDefault(),e.stopPropagation(),window.open(t(this).attr("href"),"_self")}),t(".showanalytics").find(".parentTabs").find("span.last-attempt").hide(),t(".showanalytics").find("#tabs-1").find("p.last-attempt-des").hide(),t(".showanalytics").find("#tabs-1").find("p.attempt-des").show(),m.userAttempts>1&&(t(".showanalytics").find(".parentTabs").find("span.last-attempt").show(),t(".showanalytics").find("#tabs-1").find("p.last-attempt-des").show(),t(".showanalytics").find("#tabs-1").find("p.attempt-des").hide()),setTimeout(function(){t(".showanalytics").find("ul.nav-tabs a").click(function(){if(t(this).tab("show"),480>t(window).width()){var e=t(".mobile-overflow"),a=t(".canvas-wrap");e.length>0&&e.scrollLeft((a.width()-e.width())/2)}})},100),t(".showanalytics").css("display","block"),1!=m.quizAttempt?(t("#tabs-2").find("ul").find("li").find("span.improvementcurve").show(),t("#tabs-2").find("ul").find("li").find("span.peerperformance").hide(),t("#subtab21").find(".subtabmix").show(),t("#subtab21").find(".subtabtimechart").hide()):(t("#tabs-2").find("ul").find("li").find("span.improvementcurve").hide(),t("#tabs-2").find("ul").find("li").find("span.peerperformance").show(),t("#subtab21").find(".subtabmix").hide(),t("#subtab21").find(".subtabtimechart").show()),h.length>0&&t.each(h,function(t,e){e.destroy()}),a.get_strings([{key:"zeroattempt",component:"gradereport_quizanalytics"},{key:"hardestcategories",component:"gradereport_quizanalytics"},{key:"hardestcategoriespercentage",component:"gradereport_quizanalytics"},{key:"numberofattempts",component:"gradereport_quizanalytics"},{key:"cutOffscore",component:"gradereport_quizanalytics"},{key:"score",component:"gradereport_quizanalytics"},{key:"questionnumber",component:"gradereport_quizanalytics"},{key:"questionreview",component:"gradereport_quizanalytics"},]).done(function(e){t(".attemptssnapshot").html(""),t.each(m.attemptssnapshot.data,function(e,a){var n=t.extend(m.attemptssnapshot.opt[e],{tooltips:{callbacks:{label:function(t,e){return" "+e.labels[t.index]+" : "+e.datasets[0].data[t.index]}}}});t(".attemptssnapshot").append('<label><canvas id="attemptssnapshot'+e+'"></canvas><div id="js-legend'+e+'" class="chart-legend"></div></label><div class="download"><a class="download-canvas" data-canvas_id="attemptssnapshot'+e+'"></a></div>');var i=document.getElementById("attemptssnapshot"+e).getContext("2d"),s=new Chart(i,{type:"doughnut",data:m.attemptssnapshot.data[e],options:n});document.getElementById("js-legend"+e).innerHTML=s.generateLegend(),t("#js-legend"+e).find("ul").find("li").on("click",function(e){var a=t(this).index();t(this).toggleClass("strike");var n=function t(e){for(var a in e)return e[a]}(s.config.data.datasets[0]._meta).data[a];n.hidden=!n.hidden,s.update()}),h.push(s)});var a=document.getElementById("questionpercategories").getContext("2d");void 0!==o&&o.destroy();var u={tooltips:{callbacks:{label:function(t,e){return" "+e.labels[t.index]+" : "+e.datasets[0].data[t.index]}}}},f=t.extend(m.questionPerCategories.opt,u);o=new Chart(a,{type:"pie",data:m.questionPerCategories.data,options:f}),document.getElementById("js-legendqpc").innerHTML=o.generateLegend(),t("#js-legendqpc > ul > li").on("click",function(e){var a=t(this).index();t(this).toggleClass("strike");var n=function t(e){for(var a in e)return e[a]}(o.config.data.datasets[0]._meta).data[a];n.hidden=!n.hidden,o.update()});var u={tooltips:{custom:function(t){t&&(t.displayColors=!1)}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:e[1]}}],yAxes:[{scaleLabel:{display:!0,labelString:e[2]},ticks:{beginAtZero:!0,max:100,callback:function(t){if(Number.isInteger(t))return t}}}]}},f=t.extend(m.allUsers.opt,u),a=document.getElementById("allusers").getContext("2d");void 0!==l&&l.destroy(),l=new Chart(a,{type:"bar",data:m.allUsers.data,options:f});var u={tooltips:{custom:function(t){t&&(t.displayColors=!1)}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:e[1]}}],yAxes:[{scaleLabel:{display:!0,labelString:e[2]},ticks:{beginAtZero:!0,max:100,callback:function(t){if(Number.isInteger(t))return t}}}]}},f=t.extend(m.loggedInUser.opt,u),a=document.getElementById("loggedinuser").getContext("2d");if(void 0!==i&&i.destroy(),i=new Chart(a,{type:"bar",data:m.loggedInUser.data,options:f}),null!=m.lastAttemptSummary.data&&null!=m.lastAttemptSummary.opt){t(".showanalytics").find(".unattempted").hide(),t(".showanalytics").find("#lastAttempt").show();var a=document.getElementById("lastAttempt");a.height=100;var g=a.getContext("2d");void 0!==n&&n.destroy();var u={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,e){return t.yLabel+" : "+t.xLabel},title:function(t,e){}}}},f=t.extend(m.lastAttemptSummary.opt,u);n=new Chart(g,{type:"horizontalBar",data:m.lastAttemptSummary.data,options:f})}else t(".showanalytics").find("#lastAttempt").hide(),t(".showanalytics").find("#lastAttempt").parent().append('<p class="unattempted"><b>'+e[0]+"</b></p>");var u={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,e){return e.datasets[t.datasetIndex].label+" : "+t.yLabel},title:function(t,e){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:e[3]}}],yAxes:[{scaleLabel:{display:!0,labelString:e[4]},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},f=t.extend(m.mixChart.opt,u),a=document.getElementById("mixchart").getContext("2d");void 0!==s&&s.destroy(),s=new Chart(a,{type:"line",data:m.mixChart.data,options:f});var u={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,e){return t.yLabel+" : "+t.xLabel},title:function(t,e){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:e[5]},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},f=t.extend(m.timeChart.opt,u),a=document.getElementById("timechart").getContext("2d");void 0!==d&&d.destroy(),d=new Chart(a,{type:"horizontalBar",data:m.timeChart.data,options:f});var a=document.getElementById("gradeanalysis").getContext("2d");void 0!==r&&r.destroy();var u={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,e){return"Percentage Scored ("+e.labels[t.index]+") : "+e.datasets[0].data[t.index]}}}},f=t.extend(m.gradeAnalysis.opt,u);r=new Chart(a,{type:"pie",data:m.gradeAnalysis.data,options:f}),document.getElementById("js-legendgrade").innerHTML=r.generateLegend(),t("#js-legendgrade > ul > li").on("click",function(e){var a=t(this).index();t(this).toggleClass("strike");var n=function t(e){for(var a in e)return e[a]}(r.config.data.datasets[0]._meta).data[a];n.hidden=!n.hidden,r.update()});var a=document.getElementById("questionanalysis").getContext("2d");void 0!==c&&c.destroy();var u={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return[a.datasets[t.datasetIndex].label+" : "+t.yLabel,e[7]]}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:e[6]}}],yAxes:[{scaleLabel:{display:!0,labelString:e[3]},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},f=t.extend(m.quesAnalysis.opt,u);c=new Chart(a,{type:"line",data:m.quesAnalysis.data,options:f});var u={tooltips:{custom:function(t){t&&(t.displayColors=!1)},callbacks:{label:function(t,a){return[a.datasets[t.datasetIndex].label+" : "+t.yLabel,e[7]]},title:function(t,e){}}},scales:{xAxes:[{scaleLabel:{display:!0,labelString:e[1]}}],yAxes:[{scaleLabel:{display:!0,labelString:e[3]},ticks:{beginAtZero:!0,callback:function(t){if(Number.isInteger(t))return t}}}]}},f=t.extend(m.hardestQuestions.opt,u),a=document.getElementById("hardest-questions").getContext("2d");void 0!==p&&p.destroy(),p=new Chart(a,{type:"bar",data:m.hardestQuestions.data,options:f})}))});var m=document.getElementById("questionanalysis");m&&(m.onclick=function(e){var a=c.getElementsAtEvent(e),n=a[0]._chart.config.data,i=a[0]._index,s=n.labels[i];if(void 0!==u){var l=0;t.each(u,function(t,e){if(s==e.split(",")[0]){var e=e.split(",")[1];if(0==l)var a=window.open(f+"/mod/quiz/review.php?attempt="+g+"&showall=0","","height=500,width=800");else var a=window.open(f+"/mod/quiz/review.php?attempt="+g+"&page="+l,"","height=500,width=800");return window.focus&&a.focus(),!1}l++})}});var b=document.getElementById("hardest-questions");b&&(b.onclick=function(e){var a=p.getElementsAtEvent(e),n=a[0]._chart.config.data,i=a[0]._index,s=n.labels[i];if(void 0!==u){var l=0;t.each(u,function(t,e){if(s==e.split(",")[0]){var e=e.split(",")[1];if(0==l)var a=window.open(f+"/mod/quiz/review.php?attempt="+g+"&showall=0","","height=500,width=800");else var a=window.open(f+"/mod/quiz/review.php?attempt="+g+"&page="+l,"","height=500,width=800");return window.focus&&a.focus(),!1}l++})}})}),t("#viewanalytic").one("click",function(){t(".showanalytics").find("canvas").each(function(){var e=t(this).attr("id");t(this).parent().append('<div class="download"><a class="download-canvas" data-canvas_id="'+e+'"></a></div>')})}),t("body").on("click",".download-canvas",function(){var e,a,n,i=t(this).data("canvas_id");e=this,a=i,n=i+".jpeg",e.href=document.getElementById(a).toDataURL("image/jpeg"),e.download=n})}}});