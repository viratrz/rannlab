{"version":3,"file":"form.min.js","sources":["../src/form.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the term of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * javascript for Essay (autograde) edit form\n *\n * @module      qtype_essayautograde/form\n * @category    output\n * @copyright   2018 Gordon Bateson (gordon.bateson@gmail.com)\n * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since       Moodle 3.0\n */\ndefine([\"jquery\"], function($) {\n\n    /** @alias module:qtype_essayautograde/form */\n    var JS = {};\n\n    // cache for standard width of TEXT input elements\n    JS.sizewidths = new Array();\n\n    /**\n     * initialize this AMD module\n     */\n    JS.init = function() {\n        JS.init_responseformat();\n        JS.init_target_phrases();\n        JS.init_add_button(\"addbands\", \"id_gradebands\");\n        JS.init_add_button(\"addphrases\", \"id_targetphrases\");\n    };\n\n    /**\n     * If the responseformat is changed, for example to \"Plain text\",\n     * then change the format of the related editors too.\n     */\n    JS.init_responseformat = function() {\n        var fmt = document.querySelector(\"select[name=responseformat]\");\n        $(fmt).change(function(){\n            var fmtvalue = this.options[this.selectedIndex].value;\n            var fmttext = this.options[this.selectedIndex].innerText;\n            var fmtnumber = 0;  // Moodle format\n            if (fmtvalue == \"plain\" || fmtvalue == \"monospaced\") {\n                fmtnumber = 2; // Plain text format\n            } else if (fmtvalue == \"editor\" || fmtvalue == \"editorfilepicker\") {\n                fmtnumber = 1; // HTML format\n            }\n            var names = new Array(\"responsetemplate\", \"responsesample\");\n            names.forEach(function(name){\n                // Changing the format may not immediately change the display in the browser.\n                // For example, changing from \"plain\" to \"editor\" will not magically load an editor.\n                // However, the new value will be returned to the server,\n                // and used next time the question is displayed or edited.\n                var fmt = document.querySelector(\"[name='\" + name + \"[format]']\");\n                if (fmt) {\n                    if (fmt.matches(\"select\")) {\n                        // the user has selected \"Plain text editor\" in the Editor preferences\n                        for (var i=0; i < fmt.options.length; i++) {\n                            if (fmt.options[i].value == fmtnumber) {\n                                fmt.options[i].selected = true;\n                            }\n                        }\n                    } else if (fmt.matches(\"input[type=hidden]\")) {\n                        fmt.value = fmtnumber;\n                    }\n                }\n                var txt = document.querySelector(\"[name='\" + name + \"[text]']\");\n                if (txt) {\n                    var editor = null;\n                    var editable = null;\n\n                    var elm = txt.previousElementSibling;\n                    if (elm && elm.matches(\".editor_atto\")) {\n                        editor = elm;\n                        editable = editor.querySelector(\"#id_\" + name + \"editable\");\n                    }\n\n                    var elm = txt.nextElementSibling;\n                    if (elm && elm.matches(\"#id_\" + name + \"_parent\")) {\n                        editor = elm;\n                        elm = editor.querySelector(\"#id_\" + name + \"_ifr\");\n                        if (elm) {\n                            // cross browser access to <iframe> <body>\n                            elm = (elm.contentWindow || elm.contentDocument);\n                            if (elm.document) {\n                                elm = elm.document;\n                            }\n                            editable = elm.body;\n                        }\n                    }\n\n                    if (editor) {\n                        if (fmtnumber == 0 || fmtnumber == 1) {\n                            // hide TEXTAREA\n                            txt.hidden = true;\n                            txt.style.display = \"none\";\n                        } else {\n                            // show TEXTAREA\n                            txt.hidden = false;\n                            txt.style.display = \"\";\n                            // Transfer editor content to txt.\n                            // Note that this will strip HTML tags.\n                            if (editable) {\n                                txt.value = editable.innerText;\n                            }\n                        }\n                        if (fmtnumber == 0 || fmtnumber == 2) {\n                            // hide editor\n                            editor.hidden = true;\n                            editor.style.display = \"none\";\n                            elm = editor.parentNode.querySelector(\".editor_atto_notification\");\n                            if (elm) {\n                                elm.hidden = true;\n                                elm.style.display = \"none\";\n                            }\n                        } else {\n                            // show editor\n                            editor.hidden = false;\n                            editor.style.display = \"\";\n                            // Transfer txt content to editor.\n                            if (editable) {\n                                editable.innerHTML = txt.value;\n                            }\n                        }\n                        var msg = txt.parentNode.querySelector(\"#noinline-message\");\n                        if (fmtnumber == 0) {\n                            // show message to explain why TEXTAREA and editor have disappeared\n                            if (msg) {\n                                msg.hidden = false;\n                                msg.style.display = \"\";\n                            } else {\n                                msg = document.createElement(\"DIV\");\n                                msg.setAttribute(\"id\", \"noinline-message\");\n                                msg.appendChild(document.createTextNode(fmttext));\n                                txt.parentNode.appendChild(msg);\n                            }\n                        } else if (msg) {\n                            msg.hidden = true;\n                            msg.style.display = \"none\";\n                        }\n                    }\n                }\n            });\n        });\n    };\n\n    /**\n     * Make the target phrase text boxes \"expandable\",\n     * i.e. expand/contract to fit the width of the content\n     */\n    JS.init_target_phrases = function() {\n        $(\"input[id^=id_phrasematch_]\").each(function(){\n            $(this).keyup(function(){\n                // get min width for a box with this \"size\"\n                var sizewidth = 0;\n                var size = $(this).attr(\"size\");\n                if (size) {\n                    if (size in JS.sizewidths) {\n                        sizewidth = JS.sizewidths[size];\n                    } else {\n                        var elm = document.createElement(\"INPUT\");\n                        $(elm).attr(\"size\", size);\n                        $(elm).css(\"width\", \"auto\");\n                        $(elm).hide().appendTo(\"BODY\");\n                        sizewidth = $(elm).outerWidth();\n                        $(elm).remove();\n                        JS.sizewidths[size] = sizewidth;\n                    }\n                }\n                // get required width for this text value\n                var txt = document.createTextNode($(this).val());\n                var elm = document.createElement(\"SPAN\");\n                $(elm).append(txt).hide().appendTo(\"BODY\");\n                var w = Math.max($(elm).width(), sizewidth);\n                $(elm).remove();\n                $(this).width(w);\n            });\n            $(this).triggerHandler(\"keyup\");\n        });\n    };\n\n    /**\n     * modify an \"add\" button so that the page scrolls down\n     * to the appropriate anchor when it reloads\n     *\n     * @param {string} name\n     * @param {string} anchor\n     */\n    JS.init_add_button = function(name, anchor) {\n        $(\"input[name=\" + name + \"]\").click(function(){\n            var url = $(this).closest(\"form\").prop(\"action\");\n            url = url.replace(new RegExp(\"#.*$\"), \"\");\n            $(this).closest(\"form\").prop(\"action\", url + \"#\" + anchor);\n        });\n    };\n\n    return JS;\n});\n"],"names":["define","$","JS","sizewidths","Array","init","init_responseformat","init_target_phrases","init_add_button","fmt","document","querySelector","change","fmtvalue","this","options","selectedIndex","value","fmttext","innerText","fmtnumber","forEach","name","matches","i","length","selected","txt","elm","editor","editable","previousElementSibling","nextElementSibling","contentWindow","contentDocument","body","hidden","style","display","parentNode","innerHTML","msg","createElement","setAttribute","appendChild","createTextNode","each","keyup","sizewidth","size","attr","css","hide","appendTo","outerWidth","remove","val","append","w","Math","max","width","triggerHandler","anchor","click","url","closest","prop","replace","RegExp"],"mappings":"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"}